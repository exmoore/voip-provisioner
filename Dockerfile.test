# Test Dockerfile for provisioner integration tests
FROM python:3.11-slim

WORKDIR /app

# Install dependencies first (for better caching)
COPY pyproject.toml .
RUN pip install --no-cache-dir -e .

# Copy application code
COPY src/ src/
COPY templates/ templates/
COPY inventory/ inventory/
COPY config.yml .

# Update config.yml with Asterisk test settings
# This appends the asterisk configuration to the existing config.yml
RUN cat >> config.yml <<'EOF'

asterisk:
  enabled: true
  host: asterisk
  port: 5038
  username: admin
  password: testsecret
  pjsip_config_path: /asterisk-configs/pjsip.conf
  extensions_config_path: /asterisk-configs/extensions.conf
  context: from-internal
  transport: transport-udp
  fail_on_ami_error: false
  retry_on_failure: true
  retry_max_attempts: 3
  retry_delay_seconds: 2
EOF

EXPOSE 8080

# Run the server
CMD ["python", "-m", "provisioner.server"]
